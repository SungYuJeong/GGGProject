
package com.board.action;
 
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.board.beans.board;
import com.board.controller.CommandAction;
 
public class CategoryAction implements CommandAction {
	
    public String requestPro(HttpServletRequest request,
 
    HttpServletResponse response) throws Throwable {
 
    	Class.forName("com.mysql.cj.jdbc.Driver");    	    
    	Connection conn = null;
    	Statement stmt = null;
    	ResultSet rs = null;   
    	ResultSet rs2 = null;
    	
    	//ï¿½Ë»ï¿½ï¿½É¼Ç°ï¿½ ï¿½Ë»ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½Þ¾ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½
    	String opt = request.getParameter("opt");
    	String condition = request.getParameter("condition");
    	if(condition != null) condition = new String(condition.getBytes("8859_1"), "EUC-KR");
    	
    	String category = request.getParameter("category");
    	if(category==null) category="1";
    	
    	int spage = 1;
    	String page =request.getParameter("page");
    	if(page!=null)
    		spage = Integer.parseInt(page);
  
//    	if(category==null)
//    		category="Ä§½Ç°¡±¸";
//    	else if(category.equals("1"))
//    		category="Ä§½Ç°¡±¸";
//    	else if(category.equals("2"))
//    		category="°Å½Ç°¡±¸";
//    	else if(category.equals("3"))
//    		category="¼ö³³°¡±¸";
//    	else if(category.equals("4"))
//    		category="ÁÖ¹æ°¡±¸";
//    	else if(category.equals("5"))
//    		category="Ã¥»ó,Ã¥Àå";
//    	else if(category.equals("6"))
//    		category="ÀÇÀÚ";
//    	else if(category.equals("7"))
//    		category="±âÅ¸";
//    	else
//    		category="Ä§½Ç°¡±¸";
 
    	
    	try {
    		HttpSession session = request.getSession();
    		//ï¿½Î±ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½Ç¾ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½ï¿½ï¿½ï¿½ï¿½Ë¾ï¿½ï¿½ï¿½ ï¿½Î±ï¿½ï¿½ï¿½È­ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ ï¿½Ìµï¿½    		    		
    		String id = (String) session.getAttribute("id");    		
    		if(id == null){    			
    			return "loginerror.jsp";
    		}
    		
    		String jdbcDriver = "jdbc:mysql://localhost:3306/jspdb?serverTimezone=UTC";
    		           // +
    					//		"useUnicode=true&characterEncoding = euc-kr";
    		String dbUser = "root";
    		String dbPass = "root";
    		String query = null; 
    		String query2 = null;
    		
    		if(opt == null){    			
    			query = "select * from board where typ like '%"+category+"%' order by num";
    			query2 = "SELECT * FROM board WHERE num = (SELECT max(num) FROM board)";
    		}else if(opt.equals("0")){    			
    			query = "select * from board where subject like '%"+condition+"%' order by num";        		
    		}else if(opt.equals("1")){    			
    			query = "select * from board where content like '%"+condition+"%' order by num";        		
    		}else if(opt.equals("2")){    			
    			query = "select * from board where id like '%"+condition+"%' order by num";        		
    		}
    		conn = DriverManager.getConnection(jdbcDriver, dbUser, dbPass);
    		
    		stmt = conn.createStatement();    		
    		rs = stmt.executeQuery(query);
    		
    		
    		ArrayList<board> articleList = new ArrayList<board>();    		
    		while(rs.next()){
    			board article = new board();
    			article.setNum(rs.getInt("num"));
    			article.setSubject(rs.getString("subject"));
    			article.setContent(rs.getString("content"));
    			article.setId(rs.getString("id"));
    			article.setBoarddate(rs.getString("boarddate"));
    			article.setScore(rs.getString("score"));
    			article.setImg(rs.getString("img"));
    			article.setSellOpt(rs.getString("sellOpt"));
    			article.setBorrowDay(rs.getInt("borrowDay"));
    			article.setPrice(rs.getInt("price"));
    			articleList.add(article);
    		}
    		request.setAttribute("articleList",articleList);
    		
    		int maxNum = 0;
    		if(query2!=null) {
    			rs.close();
        		stmt.close();
    			stmt = conn.createStatement();
    			rs2 = stmt.executeQuery(query2);
    			
    			 while(rs2.next()) {
        		  
      			  maxNum = (rs2.getInt("num"));
    			 }
    		  
    		}
    		// ÀüÃ¼ ÆäÀÌÁö ¼ö
            int maxPage = (int)(articleList.size()/6.0 + 0.84);
            //½ÃÀÛ ÆäÀÌÁö ¹øÈ£
            int startPage = (int)(spage/5.0 + 0.8) * 5 - 4;
            //¸¶Áö¸· ÆäÀÌÁö ¹øÈ£
            int endPage = startPage + 4;
            if(endPage > maxPage)    endPage = maxPage;
            
            System.out.println("page"+spage+" "+maxPage+" "+startPage+" "+endPage+" "+articleList.size());
            
            // 4°³ ÆäÀÌÁö¹øÈ£ ÀúÀå
            request.setAttribute("spage", spage);
            request.setAttribute("maxPage", maxPage);
            request.setAttribute("startPage", startPage);
            request.setAttribute("endPage", endPage);
            request.setAttribute("category", category);
            int pbegin = (spage-1)*6;
            int pend = (spage-1)*6+5;
            if(pbegin <0)
            	pbegin =0;
            if(pend < 0)
            	pend=0;
            request.setAttribute("pbegin", pbegin);
            request.setAttribute("pend", pend);

    	

			 
    		
    		
    	} catch(SQLException ex){
    		System.out.println("aa");
    		ex.printStackTrace();
    	} finally{
    		if(rs != null) try{rs.close();} catch(SQLException ex){}
    		if(stmt != null) try{stmt.close();} catch(SQLException ex) {}
    		
    		if(conn != null) try{conn.close();} catch(SQLException ex) {}
    	}
    	
    	if(opt==null) {
    		return "catalogue.jsp";
    	}else {
    		return "searchResult.jsp";
    	}
    }
}